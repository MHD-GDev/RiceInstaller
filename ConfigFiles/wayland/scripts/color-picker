#!/bin/bash

# Color Picker Script for Hyprland
# Dependencies: grim, slurp, imagemagick, notify-send, wl-copy

# Check if required tools are installed
check_dependencies() {
    local deps=("grim" "slurp" "magick" "notify-send" "wl-copy")
    for dep in "${deps[@]}"; do
        if ! command -v "$dep" &> /dev/null; then
            notify-send "Color Picker" "Missing dependency: $dep" -u critical
            exit 1
        fi
    done
}

# Get color from pixel coordinates
get_color() {
    local coords="$1"
    local temp_file="/tmp/colorpicker_$(date +%s).png"
    
    # Take screenshot of the selected pixel area (1x1)
    grim -g "$coords" "$temp_file"
    
    # Extract color using ImageMagick
    local hex_color=$(magick "$temp_file" -format "%[pixel:u.p{0,0}]" info:)
    
    # Clean up temp file
    rm -f "$temp_file"
    
    # magick to proper hex format
    if [[ $hex_color =~ srgb\(([0-9]+),([0-9]+),([0-9]+)\) ]]; then
        printf "#%02x%02x%02x\n" "${BASH_REMATCH[1]}" "${BASH_REMATCH[2]}" "${BASH_REMATCH[3]}"
    elif [[ $hex_color =~ ^#[0-9A-Fa-f]{6}$ ]]; then
        echo "$hex_color"
    else
        # Fallback: try to extract hex directly
        echo "$hex_color" | grep -o '#[0-9A-Fa-f]\{6\}' || echo "#000000"
    fi
}

# magick hex to RGB
hex_to_rgb() {
    local hex="$1"
    hex=${hex#"#"}
    local r=$((16#${hex:0:2}))
    local g=$((16#${hex:2:2}))
    local b=$((16#${hex:4:2}))
    echo "rgb($r, $g, $b)"
}

# Create color preview
create_preview() {
    local hex="$1"
    local preview_file="/tmp/color_preview_$(date +%s).png"
    magick -size 50x50 xc:"$hex" "$preview_file"
    echo "$preview_file"
}

# Main function
main() {
    check_dependencies
    
    while true; do
        # Use slurp to get mouse position
        local coords=$(slurp -p -f "%x,%y 1x1")
        
        if [ -z "$coords" ]; then
            notify-send "Color Picker" "Selection cancelled" -u low
            exit 0
        fi
        
        # Get the color
        local hex_color=$(get_color "$coords")
        local rgb_color=$(hex_to_rgb "$hex_color")
        
        # Create color preview
        local preview_file=$(create_preview "$hex_color")
        
        # Show notification with color preview
        notify-send -i "$preview_file" "Color at cursor" \
            "HEX: $hex_color\nRGB: $rgb_color" \
            -t 5000 \
            -u normal
            
        # Copy hex color to clipboard
        echo -n "$hex_color" | wl-copy
        
        # Clean up preview file
        rm -f "$preview_file"
        
        # Small delay to prevent too many notifications
        sleep 0.1
    done
}

# Run main function
main "$@"
