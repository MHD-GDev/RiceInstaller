#!/bin/bash
# Title: color_picker_mako

# Check for required dependencies
deps=("slurp" "grim" "magick" "notify-send")
for dep in "${deps[@]}"; do
    if ! command -v "$dep" &> /dev/null; then
        echo "Error: Dependency '$dep' is not installed." >&2
        exit 1
    fi
done

# slurp -p selects a single pixel and outputs the geometry (e.g., 926,6731,1,1)
GEOMETRY=$(slurp -p)

if [ -z "$GEOMETRY" ]; then
    exit 0
fi

# 1. grim captures *only* the single selected pixel in PNG format and pipes it.
# 2. magick reads the PNG from the pipe and outputs the color data in the 'txt' format.
# 3. tail -n 1 | awk '{print $3}' extracts the HEX code from the line: '0,0: (R,G,B) #RRGGBB srgb(R,G,B)'
COLOR_HEX=$(grim -g "$GEOMETRY" -t png - | magick - -format '%[pixel:p{0,0}]' txt:- | tail -n 1 | awk '{print $3}')

# Fallback check for an empty result or incorrectly formatted HEX
if [ -z "$COLOR_HEX" ] || [[ "$COLOR_HEX" != \#* ]]; then
    # Final attempt to check output, this often points to a missing ImageMagick component
    # The output from 'magick - -format ...' for a successful capture looks like:
    # # ImageMagick pixel enumeration: 1,1,255,srgb
    # 0,0: (12,34,56) #0C2238 srgb(12,34,56)
    # If the output is missing or truncated, the previous awk command fails.
    echo "Error: Failed to extract valid color data. Please check your 'magick' installation and its ability to process piped PNG data." >&2
    exit 1
fi

echo "$COLOR_HEX"

# Display the picked color via notify-send (for Mako)
notify-send  "Picked color: " "$COLOR_HEX"

exit 0
