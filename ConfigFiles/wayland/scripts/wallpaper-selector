#!/usr/bin/env bash
# Wallpaper selector using rofi + swaybg
# AUTHOR: MHD (optimized by Arc & Copilot)

set -euo pipefail

# --- Dependencies ---
for app in magick rofi; do
    if ! command -v "$app" &>/dev/null; then
        notify-send "Missing package" "Please install $app" -u critical
        exit 1
    fi
done

# --- Rice state ---
get_current_rice() {
    local state_file="$HOME/.config/wayland/.current_rice"
    [[ -f $state_file ]] && cat "$state_file" || echo "Bubble"
}

current_rice=$(get_current_rice)
state_cache="$HOME/.cache/current_rice"
read -r previous_rice <"$state_cache" 2>/dev/null || previous_rice="$current_rice"

wall_dir="$HOME/.config/wayland/rices/$current_rice/walls"
cache_dir="$HOME/.cache/$USER/$current_rice"

if [[ $current_rice != "$previous_rice" ]]; then
    echo "$current_rice" >"$state_cache"
    notify-send "Rice Changed" "Switched to '$current_rice' - updating wallpaper cache"
fi

mkdir -p "$wall_dir" "$cache_dir"

# --- Convert webp to png in-place ---
find "$wall_dir" -maxdepth 1 -type f -iname '*.webp' -exec mogrify -format png {} \; -delete

# --- Rofi icon size ---
monitor_res=$(xrandr | awk '/ connected/{print $3; exit}' | cut -d'x' -f1)
icon_size=$((monitor_res * 17 / 96))
rofi_override="element-icon { size: ${icon_size}px; }"

# --- Cache thumbnails ---
find "$wall_dir" -maxdepth 1 -type f \( -iname '*.jpg' -o -iname '*.jpeg' -o -iname '*.png' \) | while read -r img; do
    base=$(basename "$img")
    cache_file="$cache_dir/$base"
    md5_file="$cache_dir/.$base.md5"

    md5sum "$img" | awk '{print $1}' >"$cache_dir/.tmp.md5"
    if [[ ! -f $cache_file ]] || ! cmp -s "$cache_dir/.tmp.md5" "$md5_file"; then
        magick "$img" -resize 500x500^ -gravity center -extent 500x500 "$cache_file"
        mv "$cache_dir/.tmp.md5" "$md5_file"
    else
        rm "$cache_dir/.tmp.md5"
    fi
done

# --- Ensure wallpapers exist ---
if ! find "$wall_dir" -maxdepth 1 -type f \( -iname '*.jpg' -o -iname '*.jpeg' -o -iname '*.png' \) | grep -q .; then
    notify-send "No Wallpapers" "No wallpapers found for '$current_rice'"
    exit 1
fi

# --- Wallpaper functions ---
set_wallpaper() {
    killall swaybg 2>/dev/null || true
    swaybg -i "$1" -m fill >/dev/null 2>&1 &
    echo "$1" > "$HOME/.config/wayland/.current_wallpaper"
    # Only show notification if not running under random-wallpaper slideshow
    if [[ -z "${RANDOM_WALLPAPER_MODE:-}" ]]; then
        notify-send "Wallpaper Changed" "Applied: $(basename "$1")"
    fi
}

set_random_wallpaper() {
    wallpaper=$(find "$wall_dir" -type f \( -iname '*.jpg' -o -iname '*.jpeg' -o -iname '*.png' \) -print0 | shuf -z -n1 | xargs -0)
    [[ -n $wallpaper ]] && set_wallpaper "$wallpaper"
}

# --- CLI args ---
case "${1:-menu}" in
    random) set_random_wallpaper; exit 0 ;;
    menu|"") ;; # continue
    *) echo "Usage: $0 {menu|random}"; exit 1 ;;
esac

# --- Rofi menu ---
wall_selection=$(
    find "$wall_dir" -maxdepth 1 -type f \( -iname '*.jpg' -o -iname '*.jpeg' -o -iname '*.png' \) | while read -r img; do
        base=$(basename "$img")
        cache_file="$cache_dir/$base"
        echo -e "$base\0icon\x1f${cache_file:-$img}"
    done | rofi -dmenu \
        -p "Select Wallpaper for $current_rice:" \
        -theme ~/.config/wayland/scripts/rofi-themes/wallpaper-selector.rasi \
        -theme-str "$rofi_override" \
        -no-custom \
        -kb-row-left "h" \
        -kb-row-right "l" \
        -kb-cancel "q"
)

[[ -n $wall_selection ]] && set_wallpaper "$wall_dir/$wall_selection"
