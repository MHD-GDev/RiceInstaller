#!/bin/bash
#
#     ____  _
#    / __ \(_)_______
#   / /_/ / / ___/ _ \
    #  / _, _/ / /__/  __/
# /_/_|_/_/\___/\___/       __
#   / ___/___  / /__  _____/ /_____  _____
#   \__ \/ _ \/ / _ \/ ___/ __/ __ \/ ___/
#  ___/ /  __/ /  __/ /__/ /_/ /_/ / /
# /____/\___/_/\___/\___/\__/\____/_/
#
# Author: MHD
#
# Rice selector for Hyprland

RICE_DIR="$HOME/.config/wayland/rices"
STATE_FILE="$HOME/.config/wayland/.current_rice"
CACHE_DIR="$HOME/.cache/$USER/rice_previews"
NVIM_COLORS_FILE="$HOME/.config/nvim/rice_colors.lua"

# Create cache directory if it doesn't exist
mkdir -p "$CACHE_DIR"

# Variables to try to define the correct size of the images for your resolution
monitor_res=$(($(xrandr | grep -w "connected" | grep -o '[0-9]*x[0-9]*+[0-9]*+[0-9]*' | head -n1 | cut -d'x' -f1) * 17 / 96))
rofi_override="element-icon { size: $(($monitor_res))px; }"

# Function to extract colors from kitty config and generate nvim colors file
generate_nvim_colors() {
    local rice_name="$1"
    local kitty_config="$RICE_DIR/$rice_name/kitty/kitty.conf"

    if [[ ! -f "$kitty_config" ]]; then
        echo "Warning: Kitty config not found for rice '$rice_name'"
        return 1
    fi

    # Function to normalize hex colors (ensure 6 digits)
    normalize_hex() {
        local color="$1"
        # Remove # if present
        color="${color#\#}"
        # If 3 digits, expand to 6 (e.g., "000" -> "000000")
        if [[ ${#color} -eq 3 ]]; then
            color="${color:0:1}${color:0:1}${color:1:1}${color:1:1}${color:2:1}${color:2:1}"
        fi
        # Ensure it's exactly 6 characters, pad with zeros if needed
        printf "#%06s" "$color" | tr ' ' '0'
    }

    # Extract colors from kitty config with normalization
    local color0=$(normalize_hex "$(grep "^color0" "$kitty_config" | awk '{print $2}' | head -1)")
    local color1=$(normalize_hex "$(grep "^color1" "$kitty_config" | awk '{print $2}' | head -1)")
    local color2=$(normalize_hex "$(grep "^color2" "$kitty_config" | awk '{print $2}' | head -1)")
    local color3=$(normalize_hex "$(grep "^color3" "$kitty_config" | awk '{print $2}' | head -1)")
    local color4=$(normalize_hex "$(grep "^color4" "$kitty_config" | awk '{print $2}' | head -1)")
    local color5=$(normalize_hex "$(grep "^color5" "$kitty_config" | awk '{print $2}' | head -1)")
    local color6=$(normalize_hex "$(grep "^color6" "$kitty_config" | awk '{print $2}' | head -1)")
    local color7=$(normalize_hex "$(grep "^color7" "$kitty_config" | awk '{print $2}' | head -1)")
    local color8=$(normalize_hex "$(grep "^color8" "$kitty_config" | awk '{print $2}' | head -1)")
    local color9=$(normalize_hex "$(grep "^color9" "$kitty_config" | awk '{print $2}' | head -1)")
    local color10=$(normalize_hex "$(grep "^color10" "$kitty_config" | awk '{print $2}' | head -1)")
    local color11=$(normalize_hex "$(grep "^color11" "$kitty_config" | awk '{print $2}' | head -1)")
    local color12=$(normalize_hex "$(grep "^color12" "$kitty_config" | awk '{print $2}' | head -1)")
    local color13=$(normalize_hex "$(grep "^color13" "$kitty_config" | awk '{print $2}' | head -1)")
    local color14=$(normalize_hex "$(grep "^color14" "$kitty_config" | awk '{print $2}' | head -1)")
    local color15=$(normalize_hex "$(grep "^color15" "$kitty_config" | awk '{print $2}' | head -1)")
    local foreground=$(normalize_hex "$(grep "^foreground" "$kitty_config" | awk '{print $2}' | head -1)")
    local background=$(normalize_hex "$(grep "^background" "$kitty_config" | awk '{print $2}' | head -1)")

    # Create the nvim colors file with proper fallbacks
    cat >"$NVIM_COLORS_FILE" <<EOF
-- Auto-generated by rice switching script for rice: $rice_name
-- Generated on: $(date)
return {
    -- Base colors
    rosewater = "${color15:-#f5e0dc}",
    flamingo = "${color9:-#f2cdcd}",
    pink = "${color13:-#f5c2e7}",
    mauve = "${color5:-#cba6f7}",
    red = "${color1:-#f38ba8}",
    maroon = "${color9:-#eba0ac}",
    peach = "${color3:-#fab387}",
    yellow = "${color11:-#f9e2af}",
    green = "${color2:-#a6e3a1}",
    teal = "${color6:-#94e2d5}",
    sky = "${color14:-#89dceb}",
    sapphire = "${color12:-#74c7ec}",
    blue = "${color4:-#89b4fa}",
    lavender = "${color12:-#b4befe}",

    -- Text colors
    text = "${foreground:-#cdd6f4}",
    subtext1 = "${color7:-#bac2de}",
    subtext0 = "${color8:-#a6adc8}",
    overlay2 = "${color8:-#9399b2}",
    overlay1 = "${color8:-#7f849c}",
    overlay0 = "${color8:-#6c7086}",

    -- Surface colors
    surface2 = "${color8:-#585b70}",
    surface1 = "${color0:-#45475a}",
    surface0 = "${color0:-#313244}",
    base = "${background:-#1e1e2e}",
    mantle = "${color0:-#181825}",
    crust = "${color0:-#11111b}",
}
EOF

    echo "Generated Neovim colors file: $NVIM_COLORS_FILE"
}

# Function to reload neovim colorscheme
reload_nvim_colorscheme() {
    # Send command to all running nvim instances to reload colorscheme
    for server in $(nvim --serverlist 2>/dev/null); do
        nvim --server "$server" --remote-send '<Esc>:lua require("plugins.colorscheme")<CR>' 2>/dev/null || true
        nvim --server "$server" --remote-send '<Esc>:colorscheme catppuccin<CR>' 2>/dev/null || true
    done
}

# Get available rices
get_rices() {
    find "$RICE_DIR" -maxdepth 1 -type d -exec basename {} \; | grep -v "^rices$" | sort
}

# Get current rice
get_current_rice() {
    if [[ -f "$STATE_FILE" ]]; then
        cat "$STATE_FILE"
    else
        echo "Bubble"
    fi
}

# Get current rice index for rofi selection
get_current_rice_index() {
    local current_rice=$(get_current_rice)
    local rices=($(get_rices))
    local index=0

    for i in "${!rices[@]}"; do
        if [[ "${rices[$i]}" == "$current_rice" ]]; then
            echo "$i"
            return
        fi
    done
    echo "0"
}

# Create cached thumbnail for rice preview
create_cached_thumbnail() {
    local source_image="$1"
    local rice_name="$2"
    local cache_file="${CACHE_DIR}/${rice_name}.png"
    local md5_file="${CACHE_DIR}/.${rice_name}.md5"

    # Generate MD5 of original file
    local current_md5=$(md5sum "$source_image" | cut -d' ' -f1)

    # Check if cache file exists and if content has changed
    if [ ! -f "$cache_file" ] || [ ! -f "$md5_file" ] || [ "$current_md5" != "$(cat "$md5_file")" ]; then
        magick "$source_image" -resize 500x500^ -gravity center -extent 500x500 "$cache_file"
        echo "$current_md5" >"$md5_file"
    fi

    echo "$cache_file"
}

# Apply rice configuration
apply_rice() {
    local rice_name="$1"
    local rice_path="$RICE_DIR/$rice_name"

    if [[ ! -d "$rice_path" ]]; then
        notify-send "Rice Error" "Rice '$rice_name' not found!"
        return 1
    fi

    # Save current rice selection
    echo "$rice_name" >"$STATE_FILE"

    # Generate Neovim colors file from kitty config
    generate_nvim_colors "$rice_name"

    # Pre-select wallpaper before killing processes
    local rice_walls_dir="$rice_path/walls"
    local wallpaper=""
    if [[ -d "$rice_walls_dir" ]]; then
        wallpaper=$(find "$rice_walls_dir" -type f \( -name "*.jpg" -o -name "*.png" -o -name "*.jpeg" -o -name "*.webp" \) | shuf -n 1)
    fi

    # Kill existing processes
    killall waybar 2>/dev/null
    killall mako 2>/dev/null

    # Start new wallpaper immediately after killing old swaybg
    killall swaybg 2>/dev/null
    if [[ -n "$wallpaper" ]]; then
        swaybg -i "$wallpaper" -m fill >/dev/null 2>&1 &
    fi

    # Create symlinks to rice-specific configs
    ln -sf "$rice_path/kitty/kitty.conf" "$HOME/.config/wayland/kitty/kitty.conf"
    ln -sf "$rice_path/mako/config.ini" "$HOME/.config/wayland/mako/config.ini"
    ln -sf "$rice_path/waybar" "$HOME/.config/wayland"
    ln -sf "$rice_path/rofi/shared-colors.rasi" "$HOME/.config/wayland/scripts/rofi-themes/shared-colors.rasi"
    ln -sf "$rice_path/hypr/borders.conf" "$HOME/.config/wayland/hypr/borders.conf"

    killall -SIGUSR1 kitty 2>/dev/null

    # Reload Hyprland configuration to apply new border colors
    hyprctl reload

    # Start new processes with rice-specific configs
    waybar -c "$HOME/.config/wayland/waybar/config.jsonc" -s "$HOME/.config/wayland/waybar/style.css" >/dev/null 2>&1 &
    mako -c "$HOME/.config/wayland/mako/config.ini" >/dev/null 2>&1 &

    # Reload Neovim colorscheme
    reload_nvim_colorscheme

    # Update tmux colors for all sessions
    ~/.config/wayland/tmux/update-colors.sh 2>/dev/null || true

    # Clear wallpaper cache for new rice to force regeneration
    local new_cache_dir="$HOME/.cache/$USER/$rice_name"
    if [[ -d "$new_cache_dir" ]]; then
        find "$new_cache_dir" -name "*.jpg" -o -name "*.png" -o -name "*.jpeg" | head -5 | xargs -I {} rm -f {}
    fi

    notify-send "Rice Changed" "Applied: $rice_name rice!"
}

# Show rice selection menu with preview
show_menu() {
    local current_rice=$(get_current_rice)

    # Get available rices as array
    mapfile -t rices < <(get_rices)

    # Get selected index for current rice
    local selected_index=$(get_current_rice_index)

    # Show the rofi selection menu with image previews
    local selected=$(
        for rice in "${rices[@]}"; do
            # Look for preview image (try different formats)
            local preview_img=""
            for ext in webp png jpg jpeg; do
                if [[ -f "$RICE_DIR/$rice/preview.$ext" ]]; then
                    preview_img="$RICE_DIR/$rice/preview.$ext"
                    break
                fi
            done

            # If no preview found, use a default or the wallpaper
            if [[ -z "$preview_img" ]]; then
                local rice_walls_dir="$RICE_DIR/$rice/walls"
                if [[ -d "$rice_walls_dir" ]]; then
                    preview_img=$(find "$rice_walls_dir" -type f \( -name "*.jpg" -o -name "*.png" -o -name "*.jpeg" -o -name "*.webp" \) | head -1)
                fi
            fi

            # Output rice name with icon path
            if [[ -n "$preview_img" ]]; then
                # Create cached thumbnail and use it, ensuring it fits the window and shows top portion
                local cached_thumbnail=$(create_cached_thumbnail "$preview_img" "$rice" "256x256^")
                echo -e "$rice\0icon\x1f$cached_thumbnail"
            else
                echo "$rice"
            fi
        done | rofi -dmenu \
            -p "RiceSelector" \
            -theme ~/.config/wayland/scripts/rofi-themes/rice-selector.rasi \
            -theme-str "$rofi_override" \
            -selected-row "$selected_index" \
            -no-custom \
            -kb-row-left "h" \
            -kb-row-right "l" \
            -kb-cancel "q" \
            -fixed-num-lines true
    )
    # If a valid option was selected and it's different from current, apply it
    if [[ -n "$selected" ]]; then
        apply_rice "$selected"
    fi

}

# Initialize rice system
init_rice_system() {
    local current_rice=$(get_current_rice)
    apply_rice "$current_rice"
}

# Main logic
case "${1:-menu}" in
    "menu")
        show_menu
        ;;
    "apply")
        if [[ -n "$2" ]]; then
            apply_rice "$2"
        else
            echo "Usage: $0 apply <rice_name>"
            exit 1
        fi
        ;;
    "current")
        get_current_rice
        ;;
    "list")
        get_rices
        ;;
    "init")
        init_rice_system
        ;;
    *)
        echo "Usage: $0 {menu|init|apply <rice>|current|list}"
        exit 1
        ;;
esac
