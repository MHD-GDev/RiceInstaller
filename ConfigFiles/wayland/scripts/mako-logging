#!/usr/bin/env bash

# ┌─ MAKO LOGGING ─┐
#
# AUTHOR: MHD

LOGFILE="/tmp/mako-cache.log"

# Create the cache file if it does not exist; ensure writable
if [ ! -e "$LOGFILE" ]; then
    touch "$LOGFILE"
fi
chmod 600 "$LOGFILE"

# Listen on the session bus for Notify calls and parse summary/body
dbus-monitor --session "interface='org.freedesktop.Notifications',member='Notify'" |
    awk -v LOGFILE="$LOGFILE" '
  function write_log() {
    if (summary != "" || body != "") {
      cmd = "date +\"%Y-%m-%d %H:%M:%S\""
      cmd | getline now
      close(cmd)
      printf("[%s] %s - %s\n", now, summary, body) >> LOGFILE
      fflush(LOGFILE)
    }
  }

  # Detect start of a new Notify call
  /method call/ {
    inmsg = 1
    strings_count = 0
    summary = ""
    body = ""
    wrote = 0
    next
  }

  # Extract strings; Notify signature: 1=app_name, 2=app_icon, 3=summary, 4=body
  inmsg && /string "([^"]*)"/ {
    if (match($0, /string "([^"]*)"/, m)) {
      strings_count++
      if (strings_count == 3) summary = m[1]
      else if (strings_count == 4) body = m[1]
      if (strings_count >= 4 && wrote == 0) {
        write_log()
        wrote = 1
      }
    }
    next
  }

  # Heuristic end: on non-string fields after we captured something, write once
  inmsg && !/string "/ && wrote == 0 && (summary != "" || body != "") {
    write_log()
    wrote = 1
    next
  }
'
