#!/usr/bin/env bash
#    ______           __                  
#   / ____/__  ____  / /_____  ____       
#  / / __/ _ \/ __ \/ __/ __ \/ __ \      
# / /_/ /  __/ / / / /_/ /_/ / /_/ /      
# \____/\___/_/ /_/\__/\____/\____/       
#   / / / /___  ____/ /___ _/ /____  _____
#  / / / / __ \/ __  / __ `/ __/ _ \/ ___/
# / /_/ / /_/ / /_/ / /_/ / /_/  __(__  ) 
# \____/ .___/\__,_/\__,_/\__/\___/____/  
#     /_/                                 
# Script to check for new updates in Gentoo or Arch Linux.
# AUTHOR: MHD

# -------------------------------
# Detect distribution
# -------------------------------
detect_distro() {
    if [[ -f /etc/os-release ]]; then
        . /etc/os-release
        case "$ID" in
            gentoo) echo "gentoo" ;;
            arch) echo "arch" ;;
            *) echo "unknown" ;;
        esac
    else
        echo "unknown"
    fi
}

# -------------------------------
# Gentoo functions
# -------------------------------
get_total_updates_gentoo() {
    local total_updates
    emerge --sync --quiet >/dev/null 2>&1
    total_updates=$(emerge -puDN @world 2>/dev/null | grep -c "^

\[ebuild" || echo 0)
    echo "${total_updates:-0}"
}

get_list_updates_gentoo() {
    echo -e "\033[1m\033[34mAvailable updates:\033[0m"
    emerge -puDN @world 2>/dev/null | grep "^

\[ebuild" | sed 's/

\[ebuild/\x1b[32;1m[ebuild\x1b[0m/g'
}

get_list_overlay_updates_gentoo() {
    if command -v layman >/dev/null 2>&1; then
        echo -e "\n\033[1m\033[34mOverlay updates:\033[0m"
        layman -S >/dev/null 2>&1
        emerge -puDN @world 2>/dev/null | grep "^

\[ebuild.*::" | sed 's/

\[ebuild/\x1b[32;1m[ebuild\x1b[0m/g'
    elif command -v eselect >/dev/null 2>&1 && eselect repository list >/dev/null 2>&1; then
        echo -e "\n\033[1m\033[34mRepository updates:\033[0m"
        emerge --sync --quiet >/dev/null 2>&1
        emerge -puDN @world 2>/dev/null | grep "^

\[ebuild.*::" | sed 's/

\[ebuild/\x1b[32;1m[ebuild\x1b[0m/g'
    fi
}

print_updates_gentoo() {
    local total
    total=$(get_total_updates_gentoo)
    if [[ "$total" -gt 0 ]]; then
        echo -e "\033[1m\033[33mThere are $total updates available:\033[0m\n"
        get_list_updates_gentoo
        get_list_overlay_updates_gentoo
    else
        echo -e "\033[1m\033[32mYour system is already updated!\033[0m"
    fi
}

update_system_gentoo() {
    echo "Syncing portage tree..."
    emerge --sync
    echo "Updating system..."
    emerge -uDN @world
}

# -------------------------------
# Arch functions (paru preferred)
# -------------------------------
detect_arch_pkgmgr() {
    if command -v paru >/dev/null 2>&1; then
        echo "paru"
    elif command -v pacman >/dev/null 2>&1; then
        echo "pacman"
    else
        echo "none"
    fi
}

get_total_updates_arch() {
    local pkgmgr
    pkgmgr=$(detect_arch_pkgmgr)
    case "$pkgmgr" in
        paru) paru -Qua 2>/dev/null | wc -l ;;
        pacman) checkupdates 2>/dev/null | wc -l ;;
        *) echo 0 ;;
    esac
}

print_updates_arch() {
    local pkgmgr total
    pkgmgr=$(detect_arch_pkgmgr)
    total=$(get_total_updates_arch)
    if [[ "$total" -gt 0 ]]; then
        echo -e "\033[1m\033[33mThere are $total updates available:\033[0m\n"
        case "$pkgmgr" in
            paru) paru -Qua ;;
            pacman) checkupdates ;;
        esac
    else
        echo -e "\033[1m\033[32mYour system is already updated!\033[0m"
    fi
}

update_system_arch() {
    local pkgmgr
    pkgmgr=$(detect_arch_pkgmgr)
    echo "Updating system with $pkgmgr..."
    case "$pkgmgr" in
        paru) paru -Syu ;;
        pacman) sudo pacman -Syu ;;
        *) echo "No supported package manager found." ;;
    esac
}

# -------------------------------
# Dispatcher
# -------------------------------
DISTRO=$(detect_distro)

case "$1" in
    --get-updates)
        if [[ "$DISTRO" == "gentoo" ]]; then
            get_total_updates_gentoo
        elif [[ "$DISTRO" == "arch" ]]; then
            get_total_updates_arch
        else
            echo "Unsupported distribution."
        fi
        ;;
    --print-updates)
        if [[ "$DISTRO" == "gentoo" ]]; then
            print_updates_gentoo
        elif [[ "$DISTRO" == "arch" ]]; then
            print_updates_arch
        else
            echo "Unsupported distribution."
        fi
        ;;
    --update-system)
        if [[ "$DISTRO" == "gentoo" ]]; then
            update_system_gentoo
        elif [[ "$DISTRO" == "arch" ]]; then
            update_system_arch
        else
            echo "Unsupported distribution."
        fi
        ;;
    --help|*)
        echo -e "Updates [options]

Options:
    --get-updates       Get the number of updates available.
    --print-updates     Print the list of available packages to update.
    --update-system     Update your system.
"
        ;;
esac
