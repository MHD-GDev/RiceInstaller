#!/usr/bin/env bash
#    __  __          __      __
#   / / / /___  ____/ /___ _/ /____  _____
#  / / / / __ \/ __  / __ `/ __/ _ \/ ___/
# / /_/ / /_/ / /_/ / /_/ / /_/  __(__  )
# \____/ .___/\__,_/\__,_/\__/\___/____/
#     /_/
# Script to check for new updates in Gentoo or Arch Linux.
# Name-specific ignore: exact matches only, except patterns ending with -*.
# AUTHOR: MHD

# -------------------------------
# IGNORE LIST (permanent)
# -------------------------------
# Arch: comma-space separated, e.g. "pkg1, pkg2-*, pkg3"
IGNORE_LIST_ARCH=""

# Gentoo: space-separated, e.g. "pkgcompany/pkg1 pkgcompany/pkg2"
EXCLUDE_LIST_GENTOO=""

# -------------------------------
# Helpers
# -------------------------------
normalize_arch_ignores() {
    # Turn "pkg1, pkg2" into "pkg1,pkg2"
    echo "$1" | sed -E 's/[[:space:]]*([,!?$#])?[[:space:]]*$//; s/[[:space:]]*,[[:space:]]*/,/g'
}

# -------------------------------
# Detect distribution
# -------------------------------
detect_distro() {
    if [[ -f /etc/os-release ]]; then
        . /etc/os-release
        case "$ID" in
        gentoo) echo "gentoo" ;;
        arch) echo "arch" ;;
        *) echo "unknown" ;;
        esac
    else
        echo "unknown"
    fi
}

# -------------------------------
# Gentoo functions
# -------------------------------
get_total_updates_gentoo() {
    emerge --sync --quiet >/dev/null 2>&1
    emerge -puDN @world 2>/dev/null | grep -c "^

\[ebuild"
}

gentoo_filter_updates() {
    local patterns="$1"
    awk -v pats="$patterns" '
        BEGIN{n=split(pats,a," ")}
        {
            line=$0
            atom=""
            for (i=1;i<=NF;i++) if ($i ~ /\//) {split($i,p,"::"); split(p[1],q,"-"); atom=q[1]; break}
            skip=0
            for (i=1;i<=n;i++) {
                pat=a[i]
                if(pat=="") continue
                if(pat ~ /-\*$/) {
                    base=substr(pat,1,length(pat)-1)
                    if(index(atom,base)==1 && atom!=base) {skip=1; break}
                } else {
                    if(atom==pat) {skip=1; break}
                }
            }
            if(!skip) print line
        }'
}

print_updates_gentoo() {
    local total excludes
    total=$(get_total_updates_gentoo)
    excludes="$EXCLUDE_LIST_GENTOO $EXCLUDE"

    if [[ "$total" -gt 0 ]]; then
        if [[ -n "$excludes" ]]; then
            echo -e "\033[1;31mIgnoring patterns:\033[0m $excludes\n"
        fi
        echo -e "\033[1m\033[33mThere are $total updates available:\033[0m\n"

        emerge -puDN @world 2>/dev/null |
            grep "^

\[ebuild" |
            gentoo_filter_updates "$excludes" |
            sed -E \
                -e "s/^(

\[ebuild[^\]

]*\]

)/\033[35m\1\033[0m/" \
                -e "s/([a-z0-9+_.-]+\/[a-z0-9+_.-]+)/\033[36m\1\033[0m/g" \
                -e "s/([0-9]+\.[0-9]+[^\s]*)/\033[33m\1\033[0m/g"
    else
        echo -e "\033[1m\033[32mYour system is already updated!\033[0m"
    fi
}

update_system_gentoo() {
    echo "Syncing portage tree..."
    emerge --sync
    echo "Updating system..."
    local excludes="$EXCLUDE_LIST_GENTOO $EXCLUDE"
    [[ -n "$excludes" ]] && emerge -uDN @world --exclude "$excludes" || emerge -uDN @world
}

# -------------------------------
# Arch functions
# -------------------------------
detect_arch_pkgmgr() {
    if command -v paru >/dev/null 2>&1; then
        echo "paru"
    elif command -v pacman >/dev/null 2>&1; then
        echo "pacman"
    else echo "none"; fi
}

arch_filter_updates() {
    local patterns="$1"
    awk -v pats="$patterns" '
        BEGIN{n=split(pats,a,",")}
        {
            name=$1
            skip=0
            for(i=1;i<=n;i++){
                pat=a[i]
                if(pat=="") continue
                if(pat ~ /-\*$/){
                    base=substr(pat,1,length(pat)-1)
                    if(index(name,base)==1 && name!=base){skip=1; break}
                } else {
                    if(name==pat){skip=1; break}
                }
            }
            if(!skip) print
        }'
}

print_updates_arch() {
    local mgr=$(detect_arch_pkgmgr)
    local patterns=$(normalize_arch_ignores "$IGNORE_LIST_ARCH")
    [[ -n "$EXCLUDE" ]] && patterns="${patterns:+$patterns,}$EXCLUDE"

    case "$mgr" in
    paru)
        if [[ -n "$patterns" ]]; then
            echo -e "\033[1;31mIgnoring patterns:\033[0m $patterns\n"
            echo -e "\033[1;33mAvailable Updates:\033[0m"
            echo
        fi
        paru -Qu | arch_filter_updates "$patterns" |
            awk '{printf "\033[36m%-30s\033[0m \033[32m%s\033[0m → \033[33m%s\033[0m\n",$1,$2,$4}'
        ;;
    pacman)
        if [[ -n "$patterns" ]]; then
            echo -e "\033[1;31mIgnoring patterns:\033[0m $patterns"
            echo -e "\033[1;33mAvailable Updates:\033[0m"
            echo
        fi
        checkupdates | arch_filter_updates "$patterns" |
            awk '{printf "\033[36m%-30s\033[0m \033[32m%s\033[0m → \033[33m%s\033[0m\n",$1,$2,$4}'
        ;;
    esac | bat --paging=never --style=plain | bat || bat
}

update_system_arch() {
    local mgr=$(detect_arch_pkgmgr)
    local patterns=$(normalize_arch_ignores "$IGNORE_LIST_ARCH")
    [[ -n "$EXCLUDE" ]] && patterns="${patterns:+$patterns,}$EXCLUDE"

    echo "Updating system with $mgr..."
    case "$mgr" in
    paru) [[ -n "$patterns" ]] && paru -Syu --ignore "$patterns" ;;
    pacman) [[ -n "$patterns" ]] && sudo pacman -Syu --ignore "$patterns" ;;
    esac
}

# -------------------------------
# Argument parsing
# -------------------------------
EXCLUDE=""
ARGS=()
while [[ $# -gt 0 ]]; do
    case "$1" in
    --exclude)
        shift
        EXCLUDE="$1"
        ;;
    *) ARGS+=("$1") ;;
    esac
    shift
done

DISTRO=$(detect_distro)

# -------------------------------
# Dispatcher
# -------------------------------
case "${ARGS[0]}" in
--total)
    [[ "$DISTRO" == "gentoo" ]] && get_total_updates_gentoo ||
        [[ "$DISTRO" == "arch" ]] && print_updates_arch | wc -l ||
        echo "Unsupported distribution."
    ;;
--list)
    [[ "$DISTRO" == "gentoo" ]] && print_updates_gentoo ||
        [[ "$DISTRO" == "arch" ]] && print_updates_arch ||
        echo "Unsupported distribution."
    ;;
--update)
    [[ "$DISTRO" == "gentoo" ]] && update_system_gentoo ||
        [[ "$DISTRO" == "arch" ]] && update_system_arch ||
        echo "Unsupported distribution."
    ;;
--help | *)
    echo -e "Updates [options]

Options:
    --total             Get the number of updates available.
    --list              Print the list of available packages to update.
    --update            Update your system.
    --exclude <pkg>     Exclude a package just for this run.
                        Exact names only, except patterns ending with -*.

Permanent ignores:
    Arch: set IGNORE_LIST_ARCH with comma-space separation, e.g. \"pkg1, pkg2-*, pkg3\"
    Gentoo: set EXCLUDE_LIST_GENTOO with space separation, e.g. \"pkgcompany/pkg1 pkgcompany/pkg2\"
"
    ;;
esac
