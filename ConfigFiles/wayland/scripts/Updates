#!/usr/bin/env bash
#    ______           __                  
#   / ____/__  ____  / /_____  ____       
#  / / __/ _ \/ __ \/ __/ __ \/ __ \      
# / /_/ /  __/ / / / /_/ /_/ / /_/ /      
# \____/\___/_/ /_/\__/\____/\____/       
#   / / / /___  ____/ /___ _/ /____  _____
#  / / / / __ \/ __  / __ `/ __/ _ \/ ___/
# / /_/ / /_/ / /_/ / /_/ / /_/  __(__  ) 
# \____/ .___/\__,_/\__,_/\__/\___/____/  
#     /_/                                 
# Script to check for new updates in Gentoo Linux.
# AUTHOR: MHD

get_total_updates() {
    local total_updates
    # Sync portage tree first (quietly)
    emerge --sync --quiet >/dev/null 2>&1
    # Count available updates
    total_updates=$(emerge -puDN @world 2>/dev/null | grep -c "^\[ebuild" || echo 0)
    echo "${total_updates:-0}"
}

get_list_updates() {
    echo -e "\033[1m\033[34mAvailable updates:\033[0m"
    emerge -puDN @world 2>/dev/null | grep "^\[ebuild" | sed 's/\[ebuild/\x1b[32;1m[ebuild\x1b[0m/g'
}

get_list_overlay_updates() {
    # Check for overlay updates if layman or eselect repository is available
    if command -v layman >/dev/null 2>&1; then
        echo -e "\n\033[1m\033[34mOverlay updates:\033[0m"
        layman -S >/dev/null 2>&1
        emerge -puDN @world 2>/dev/null | grep "^\[ebuild.*::" | sed 's/\[ebuild/\x1b[32;1m[ebuild\x1b[0m/g'
    elif command -v eselect >/dev/null 2>&1 && eselect repository list >/dev/null 2>&1; then
        echo -e "\n\033[1m\033[34mRepository updates:\033[0m"
        emerge --sync --quiet >/dev/null 2>&1
        emerge -puDN @world 2>/dev/null | grep "^\[ebuild.*::" | sed 's/\[ebuild/\x1b[32;1m[ebuild\x1b[0m/g'
    fi
}

print_updates() {
    local print_updates
    print_updates=$(get_total_updates)

    if [[ "$print_updates" -gt 0 ]]; then
        echo -e "\033[1m\033[33mThere are $print_updates updates available:\033[0m\n"
        get_list_updates
        get_list_overlay_updates
    else
        echo -e "\033[1m\033[32mYour system is already updated!\033[0m"
    fi
}

update_system() {
    echo "Syncing portage tree..."
    emerge --sync
    echo "Updating system..."
    emerge -uDN @world
}

case "$1" in
    --get-updates) get_total_updates ;;
    --print-updates) print_updates ;;
    --update-system) update_system ;;
    --help|*)echo -e "Updates [options]

Options:
	--get-updates		Get the number of updates available.
	--print-updates		Print the number of available package to update.
	--update-system		Update your system including overlay packages.\n"
esac
