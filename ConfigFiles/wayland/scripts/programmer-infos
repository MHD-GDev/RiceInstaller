#!/bin/bash
# deep-programmer-info-colored.sh
# Full developer environment audit with ANSI colored headers and bat output

has() { command -v "$1" >/dev/null 2>&1; }

# --- Colors ---
BOLD="\033[1m"
RESET="\033[0m"
CYAN="\033[1;36m"
MAGENTA="\033[1;35m"
YELLOW="\033[1;33m"
GREEN="\033[1;32m"

header() {
  printf "${MAGENTA}%s${RESET}\n" "$1"
}

subheader() {
  printf "${CYAN}%s${RESET}\n" "$1"
}

# --- OS / Kernel / Arch ---
OS="$(uname -s 2>/dev/null)"
KERNEL="$(uname -r 2>/dev/null)"
ARCH="$(uname -m 2>/dev/null)"

# --- CPU Model & Flags ---
if has lscpu; then
  CPU_MODEL="$(lscpu | awk -F: '/Model name/ {gsub(/^ +/,"",$2); print $2; exit}')"
  CPU_FLAGS="$(lscpu | awk -F: '/Flags/ {gsub(/^ +/,"",$2); print $2}')"
elif [ -r /proc/cpuinfo ]; then
  CPU_MODEL="$(awk -F': ' '/^model name/ {print $2; exit}' /proc/cpuinfo)"
  CPU_FLAGS="$(awk -F': ' '/^flags/ {print $2; exit}' /proc/cpuinfo)"
elif has sysctl; then
  CPU_MODEL="$(sysctl -n hw.model 2>/dev/null || echo N/A)"
  CPU_FLAGS="$(sysctl -a 2>/dev/null | awk -F= '/machdep.cpu.features/ {print $2}')"
fi

# --- Memory / Disk ---
MEM=$(free -h 2>/dev/null | awk '/Mem:/ {print $3 "/" $2}') || MEM="N/A"
DISK=$(df -h / | awk 'NR==2 {print $3 "/" $2 " (" $5 ")"}') || DISK="N/A"

# --- Compilers & Build Tools ---
GCC=$(has gcc && gcc --version | head -1 || echo N/A)
CLANG=$(has clang && clang --version | head -1 || echo N/A)
CMAKE=$(has cmake && cmake --version | head -1 || echo N/A)
MAKE=$(has make && make --version | head -1 || echo N/A)
NINJA=$(has ninja && ninja --version | head -1 || echo N/A)

# --- Rust ---
RUSTC=$(has rustc && rustc --version || echo N/A)
CARGO=$(has cargo && cargo --version || echo N/A)
RUST_TARGETS=$(has rustup && rustup target list --installed | tr '\n' ', ' || echo N/A)
RUST_TOOLS=$(has cargo && cargo install --list 2>/dev/null | awk '{print $1}' | paste -sd ', ' - || echo N/A)

# --- Go ---
GO=$(has go && go version || echo N/A)
GOROOT=$(has go && go env GOROOT || echo N/A)
GOPATH=$(has go && go env GOPATH || echo N/A)

# --- Zig ---
ZIG=$(has zig && zig version || echo N/A)

# --- Java / .NET ---
JAVA=$(has java && java -version 2>&1 | head -1 || echo N/A)
JAVAC=$(has javac && javac -version 2>&1 || echo N/A)
DOTNET=$(has dotnet && dotnet --version || echo N/A)

# --- Python ---
PYTHON=$(has python3 && python3 --version || echo N/A)
PIP=$(has pip3 && pip3 --version || echo N/A)
PY_SITE=$(has python3 && python3 -m site --user-site || echo N/A)
PY_PACKAGES=$(has pip3 && pip3 list --format=columns 2>/dev/null | head -10 || echo "N/A")

# --- Node.js / JS runtimes ---
NODE=$(has node && node --version || echo N/A)
NPM=$(has npm && npm --version || echo N/A)
NPM_GLOBAL=$(has npm && npm list -g --depth=0 2>/dev/null | tail -n +2 | head -10 || echo "N/A")
YARN=$(has yarn && yarn --version || echo N/A)
PNPM=$(has pnpm && pnpm --version || echo N/A)
BUN=$(has bun && bun --version || echo N/A)
DENO=$(has deno && deno --version | head -1 || echo N/A)

# --- Ruby ---
RUBY=$(has ruby && ruby --version || echo N/A)
GEM=$(has gem && gem --version || echo N/A)
GEMS=$(has gem && gem list --local | head -10 || echo "N/A")

# --- Git & Containers ---
GIT=$(has git && git --version || echo N/A)
DOCKER=$(has docker && docker --version | head -1 || echo N/A)
PODMAN=$(has podman && podman --version | head -1 || echo N/A)

# --- Environment Variables ---
ENV_PATH="$PATH"
PKG_CONFIG_PATH="${PKG_CONFIG_PATH:-N/A}"
LD_LIBRARY_PATH="${LD_LIBRARY_PATH:-N/A}"

# --- Build Report ---
REPORT="$(
  header '================ Deep Programmer System Info ================'
  echo -e "${YELLOW}OS/Kernel/Arch:${RESET} $OS / $KERNEL / $ARCH\n"
  echo -e "${YELLOW}CPU:${RESET} $CPU_MODEL"
  echo -e "${YELLOW}CPU Flags:${RESET} $CPU_FLAGS\n"
  echo -e "${YELLOW}Memory:${RESET} $MEM"
  echo -e "${YELLOW}Disk (/):${RESET} $DISK\n"

  header 'C / C++ Toolchains'
  echo "$GCC"
  echo "$CLANG"
  echo "$CMAKE"
  echo "$MAKE"
  echo "$NINJA"
  echo

  header 'Rust'
  echo "$RUSTC"
  echo "$CARGO"
  echo -e "${GREEN}Rust targets:${RESET} $RUST_TARGETS"
  echo -e "${GREEN}Cargo tools:${RESET} $RUST_TOOLS"
  echo

  header 'Go'
  echo "$GO"
  echo -e "GOROOT: $GOROOT"
  echo -e "GOPATH: $GOPATH"
  echo

  header 'Zig'
  echo "$ZIG"
  echo

  header 'Java / .NET'
  echo "$JAVA"
  echo "$JAVAC"
  echo ".NET: $DOTNET"
  echo

  header 'Python'
  echo "$PYTHON"
  echo "$PIP"
  echo "Site-packages: $PY_SITE"
  echo "Top packages:"
  echo "$PY_PACKAGES"
  echo

  header 'Node.js / JS'
  echo "$NODE"
  echo "npm: $NPM"
  echo "Global npm pkgs:"
  echo "$NPM_GLOBAL"
  echo "yarn: $YARN"
  echo "pnpm: $PNPM"
  echo "bun: $BUN"
  echo "deno: $DENO"
  echo

  header 'Ruby'
  echo "$RUBY"
  echo "gem: $GEM"
  echo "Top gems:"
  echo "$GEMS"
  echo

  header 'Git / Containers'
  echo "$GIT"
  echo "Docker: $DOCKER"
  echo "Podman: $PODMAN"
  echo

  header 'Environment'
  echo "PATH: $ENV_PATH"
  echo "PKG_CONFIG_PATH: $PKG_CONFIG_PATH"
  echo "LD_LIBRARY_PATH: $LD_LIBRARY_PATH"
  header '=============================================================='
)"

# --- Display with bat if available ---
if command -v bat >/dev/null 2>&1; then
    echo -e "$REPORT" | bat --plain --language=txt
elif command -v less >/dev/null 2>&1; then
    echo -e "$REPORT" | less
else
    echo -e "$REPORT"
fi

